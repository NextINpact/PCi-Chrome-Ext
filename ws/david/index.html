<!DOCTYPE html>
<html lang="fr">
<head>
    <title>PCi WebSockets Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="../aes.js"></script>
    <script type="text/javascript" src="../jsHash.js"></script>
    <script type="text/javascript" src="../cryptoHelpers.js"></script>
    <script type="text/javascript" src="../md5.js"></script>

    <script type="text/javascript" src="../PCiTk.js"></script>
    <script type="text/javascript" src="http://ws-pci.cloudapp.net/Scripts/ToolkitConfig"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="bootstrap/js/bootstrap.js"></script>

    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

    <style type="text/css">
        body {
            min-width: 650px;
        }

        pre, #actu {
            -webkit-transition: all 5s ease-in-out;
        }

        #benchmark {
            margin-left: 10px;
        }

        #loginForm {
            margin-bottom: 20px;
        }

        .navbar .brand {
            padding-top: 10px;
            margin-left: 20px;
            font-weight: bold;
            color: black;
            text-shadow: 0 1px 0 rgba(255,255,255,.1), 0 0 30px rgba(255,255,255,.125);
        }
    </style>
    <title></title>
</head>
<body>
    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <span class="brand">PC INpact WebSockets - Proof of Concept</span>
                <button class="btn pull-right" id="btnDisconnect">Déconnecter</button>
                <button class="btn pull-right" id="btnClear">Nettoyage</button>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="well">
            <div class="page-header">
                <h1>Suivi des actualités et des commentaires :</h1>
            </div>
            <div class="form-inline">
                <div id="loginForm">
                    <input type="text" id="login" placeholder="Login">
                    <input type="password" id="pass" placeholder="Mot de passe">
                    <button class="btn btn-primary" id="btnValid">Connexion</button>
                </div>
                <div id="benchZone" class="alert"><span id="benchmark"></span><a class="close" data-dismiss="alert" href="#">&times;</a></div>
            </div>
            <div class="alert" id="messageZone"></div>
            <div id="result"></div>
            <div id="chartDiv" style="width: 600px; height: 300px; margin: 0 auto;"></div>
        </div>
    </div>
</body>

<script type="text/javascript">

    // Zone de test
    $('.dropdown-toggle').dropdown();
    $('form').submit(function () {
        // On submit disable its submit button
        $('input[type=submit]', this).attr('disabled', 'disabled');
    });

    $("#chartDiv").hide();

    google.load('visualization', '1.0', { 'packages': ['corechart'] });

    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawChart);

    // Callback that creates and populates a data table, 
    // instantiates the pie chart, passes in the data and
    // draws it.
    var fullArray = [["Secondes", "Score"], ["0", 0]];

    function drawChart() {

        // Create the data table.
        var data = google.visualization.arrayToDataTable(fullArray);
        // Set chart options
        var options = {
            title: "Benchmark - Commentaires par minute",
            legend: { position: "none" },

        };

        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.SteppedAreaChart(document.getElementById('chartDiv'));
        chart.draw(data, options);
    }

    /////////////////////////////

    // On initialise le fonctionnement des différents boutons
    document.getElementById("btnValid").addEventListener("click", initPCiWS);
    document.getElementById("btnDisconnect").addEventListener("click", window.PciTk.WsClient.Disconnect);
    document.getElementById("btnClear").addEventListener("click", function (e) {
        document.getElementById("result").innerText = "";
    });

    // Lorsque le DOM est chargé, on lance une demande d'Auth par Token
    window.addEventListener("DOMContentLoaded", function () {
        console.log("Auth par Token demandé");
        window.PciTk.Init();
        launchWSProcess();
    });

    // On déclare les variables globales qui seront utiles
    var messageZone = document.getElementById("messageZone");
    var benchmarkZone = document.getElementById("benchmark");
    var tickActivated = false;
    var debut;
    var compteur = 0;

    // La fonction de login manuelle
    function initPCiWS() {

        var login = $("#login").val();
        var pass = $("#pass").val();

        if (login != "" && pass != "") window.PciTk.Init(login, pass);
        else window.PciTk.Init();

        launchWSProcess();
    }

    // La fonction qui initialise le benchmark de commentaires
    function setBenchmarkUpdater(zone) {
        $("#benchZone").addClass("alert-info");
        $("#chartDiv").show();
        var c = 0;

        setInterval(function () {
            console.log("tick");
            var delai_min = (Date.now() - debut) / 1000 / 60;
            var score = Math.round(compteur / delai_min * 100) / 100;
            $("#benchmark").text(score + " commentaire(s) par minute");

            if (fullArray.length > 50 || c == 1) fullArray.splice(1, 1);
            if (c != 0) fullArray.push([c.toString(), score]);

            drawChart();
            c++;
        }, 1000);
    }

    // La fonction qui regroupe tout ce qui est relatif à la gestion de la connexion au WS
    function launchWSProcess() {

        message.show("Connexion en cours...", "black");

        window.PciTk.WsClient.OnAuthFailed = function (method, mess) {
            message.show("Identification INcorrecte. Methode : " + method + " - Message : " + mess, "red");
        };

        window.PciTk.WsClient.OnDisconnected = function () {
            message.show("Vous avez bien été déconnecté", "black");
            $("#login,#pass,#btnValid").show("slow");
            $("#benchmark").hide("fast");
        };

        window.PciTk.WsClient.OnConnected = function () {

            // On indique à l'utilisateur qu'il est bien connecté, avant de faire disparaitre le message
            message.show("Vous êtes bien connecté", "red");
            $("#login,#pass,#btnValid").hide("slow");

            setTimeout(function () {
                message.hide();
            }, 3000);

            $("#benchmark").text("En attente de contenu...").show();

            debut = Date.now();

            window.PciTk.WsClient.OnMessage = function (jsonData) {

                console.log(jsonData);
                if (jsonData.Content.length > 0) {
                    if (!tickActivated) setBenchmarkUpdater();
                    tickActivated = true;

                    switch (jsonData.ChannelName) {
                        case "Actu":

                            var actus = jsonData.Content;

                            var zone = document.createElement("div");
                            zone.className = "actu well";
                            zone.id = "content_" + actus[0].id;

                            var img = document.createElement("img");
                            img.src = "http://static.pcinpact.com/images/bd/dedicated/" + actus[0].id;
                            img.align = "left";
                            img.hspace = 5;
                            img.height = 50;

                            var url = "http://www.pcinpact.com/";
                            url += actus[0].is_breve ? "breve/" : "news/";
                            url += actus[0].seo_url + ".htm";

                            var actuTitre = document.createElement("a");
                            actuTitre.innerText = actus[0].titre;
                            actuTitre.target = "_blank";
                            actuTitre.href = url;

                            var ssTitre = document.createElement("p");
                            ssTitre.innerText = actus[0].AutoSousTitre;

                            if ($("#result").children().length > 0) $("#result:first").children().before(zone);
                            else $("#result").append(zone);

                            $("#" + zone.id).append(img, actuTitre, ssTitre);

                            while ($("#result > div").length >= 5) $("#result > div:last-child").delay(2000).remove();

                            // On applique une couleur à l'élément rajouté, puis une autre
                            // On rajoute un décalage de quelques secondes pour que la transition CSS3 puisse opérer
                            $("#result > div:first").css("background-color", "#FFFFCC");
                            setTimeout(function () {
                                $("#result > div:first").css("background-color", "white");
                            }, 2000);

                            break;

                        case "Comment":

                            var comments = jsonData.Content;


                            for (var i = 0; i < comments.length ; i++) {

                                var d = new Date();
                                var dS = d.toLocaleString();

                                var elmt = document.createElement("pre");
                                elmt.innerText = dS + " - Nouveau commentaire sur l'actualité [" + comments[i].Id + "] (" + comments[i].State.NbComments + ")";

                                if ($("#result").children().length > 0) $("#result:first").children().before(elmt);
                                else $("#result").append(elmt);

                                while($("#result > pre").length >= 5) $("#result > pre:last-child").delay(2000).remove();

                                // On applique une couleur à l'élément rajouté, puis une autre
                                // On rajoute un décalage de quelques secondes pour que la transition CSS3 puisse opérer
                                $("#result > pre:first").css("background-color", "#FFFFCC");
                                setTimeout(function () {
                                    $("#result > pre:first").css("background-color", "white");
                                }, 2000);

                                compteur++;

                            }
                            break;
                    }
                }
            };

            var subscriptions = [];

            // Pour les essais, on surveille les actus 73000 à 73099
            var ids = [];
            for (var i = 73000; i < 73100; i++) {
                ids.push(i);
            }

            // On lance les souscriptions et on rempli le tableau permettant de les gérer par la suite
            var sobjComment = window.PciTk.WsClient.SubscribeToComment(ids);
            var sobjNews = window.PciTk.WsClient.SubscribeToNews();

            subscriptions.push(sobjComment);
            subscriptions.push(sobjNews);

        };

        window.PciTk.WsClient.Connect();
    }

    // L'objet de gestion de la zone de message
    var message = {

        show: function (message, color) {
            $("#messageZone").css("color", color).text(message).show("fast");
        },

        hide: function () {
            $("#messageZone").hide("fast");
        }
    }
</script>

</html>
