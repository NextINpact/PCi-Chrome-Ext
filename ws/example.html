<!-- NOTICE IMPORTANTE : Ne pas oublier d'inclure les libs crypto -->
<script type="text/javascript" src="../../Scripts/enc/jsHash.js"></script>
<script type="text/javascript" src="../../Scripts/enc/cryptoHelpers.js"></script>
<script type="text/javascript" src="../../Scripts/enc/aes.js"></script>
<script type="text/javascript" src="../../Scripts/enc/md5.js"></script>
<!--- Fin notice IMPORTANTE -->


<script type="text/javascript" src="/Scripts/Toolkit/PCiTk.js"></script>
<script type="text/javascript" src="url_script_initialisation_urls"></script><!-- Permet d'obtenir les urls des services WebSocket. Sera prochainement rajouté dans le Tk.-->
<script type="text/javascript">

    //cet objet permet de sauvegarder les souscriptions pour la session en cours
    window.AllSubscription = {};
    $('#stopApp').live('click', function () {
        window.PciTk.WsClient.Disconnect();
    });
    $('#startApp').live('click', function (event) {
        var password = $('#password').val();
        var username = $('#username').val();

        if (username != "" && password != "") {
            window.PciTk.Init(username, password);
            Start();
        } else {
            alert("Veuillez renseigner un nom d'utilisateur et un mot de passe");
        }
    });

    $(document).ready(function () {
        
        //Si l'on s'est déjà connecté auparavant sur ce navigateur, il doit être possible de se reconnecter via la clé d'authentification gérée par le Tk
        try {
            window.PciTk.Init();
            Start();
        } catch (e) {
            //il semble qu'il n'y ai eu aucune session précédente
            alert('Veuillez vous identifier via le formulaire pour acceder au service');
        }
    });
    function Start() {
        //cet evenement se produit si l'authentification est incorrecte
        window.PciTk.WsClient.AttachEvent('OnAuthFailed', function(method, message) {
            alert("Identification incorrecte. Methode :" + method, " avec le message :" + message);
        });
        
        //cet evenement se produit lorsque le socket est connecté, et que l'authentification est réussie.
        window.PciTk.WsClient.AttachEvent('OnConnected', function () {
            //no comment =)
            window.PciTk.WsClient.AttachEvent('OnDisconnected', function () {
                alert('la connection est fermée ! :(');
            });

            //nous creeons la fonction permettant de récuperer les messages du server
            window.PciTk.WsClient.AttachEvent('OnMessage',function (method,jsonData) {

                //selon le canal de réponse, on traite les données
                var entry;
                var i;
                switch (jsonData.ChannelName) {
                    case "Comment":
                        //le but de cet exemple est d'afficher les nombre de commentaires en couleur rouge pour les données arrivées
                        $('.nb_comments').css('color', 'black');
                        for (i in jsonData.Content) {
                            entry = jsonData.Content[i];
                            var id = entry.Id;
                            var nbComments = entry.State.NbComments;
                            var currentNb = parseInt($('.nb_comments[itemref=' + id + ']').text());
                            var diff = nbComments - currentNb;

                            $('.nb_comments[itemref=' + id + ']').css('color', 'red').text(nbComments);
                            document.getElementById('signal-api').play();
                            $("#announcer").show();
                            $('#announcer').text(diff + " nouveaux commentaires sur l'actu n° " + id);
                            setTimeout(function () { $('#announcer').fadeOut('slow'); }, 2000);

                        }
                        break;
                    case "Actu":
                        for (i in jsonData.Content) {
                            //on creer l'entrée dans la liste d'actu
                            entry = jsonData.Content[i];
                            var lineElm = $('<li></li>').text('[' + entry.id + '] ' + entry.titre);
                            var cmtElm = $('<span></span>').attr('itemref', entry.id).attr('class', 'nb_comments').text(entry.NbComments);
                            lineElm.append(cmtElm);
                            $('#actu_container').prepend(lineElm);
                            //on met à jour la souscription au channel comment
                            SetCommentChannel(true);
                        }

                        break;

                    default:
                        break;
                }

            });
            

            //Nous souscrivons au channel qui permet d'obtenir le nombre de commentaires en temps réel
            SetCommentChannel(false);

            //Nous souscrivons au channel permettant d'obtenir les actus en temps réel
            var actuSub = window.PciTk.WsClient.SubscribeToNews();
            window.AllSubscription.Actu = actuSub;

        });

        window.PciTk.WsClient.Connect();


    }
    //Permet de souscire ou de mettre a jour la souscription au canal Comment
    function SetCommentChannel(isUpdate) {
        //Nous récuperons tous les ids de la page
        var newsIds = new Array;
        $('.nb_comments').each(function () {
            newsIds.push(parseInt($(this).attr('itemref')));
        });

        //Nous souscrivons au channel qui permet d'obtenir les actus en temps réels, ou nous mettons a jour cette même souscription
        var commentSub;
        if (!isUpdate) {
            commentSub = window.PciTk.WsClient.SubscribeToComment(newsIds);
            window.AllSubscription.Comment = commentSub;
        } else {
            try {
                commentSub = window.AllSubscription.Actus;
                commentSub.Args = newsIds;
                window.PciTk.WsClient.UpdateSubscription(commentSub);
            }
            catch (e) {
                console.log("Impossible de mettre a jour : " + e.toString());
            }

        }
    }
</script>